<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no"/>
    <title>Versterk je Geheugen</title>

    <!-- ✅ BASIS: A-Frame engine -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <!-- 🌍 Extra componenten: movement, navmesh, enz. -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>

    <!-- ⚙️ Physics: zwaartekracht en botsingen -->
    <script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>

    <!-- 🌲 Omgeving: snel bos, woestijn, etc. genereren -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>

    <!-- 🧩 Eigen componenten -->
    <script>
      // Loader component (fix bug #5251)
      AFRAME.registerComponent('preload-assets', {
        init: function () {
          const assetIds = ['#blauw', '#groen', '#oranje', '#navmesh', '#castle'];
          const promises = assetIds.map(id => {
            const el = document.querySelector(id);
            return new Promise((resolve, reject) => {
              if (el.tagName === 'IMG') {
                if (el.complete) resolve();
                else { el.onload = resolve; el.onerror = reject; }
              } else { // glTF assets
                el.addEventListener('loaded', resolve);
                el.addEventListener('error', reject);
              }
            });
          });

          Promise.all(promises)
            .then(() => {
              console.log('Alle assets zijn geladen!');
              document.getElementById('loader').style.display = 'none';
            })
            .catch(err => {
              console.error('Fout bij laden van assets:', err);
              document.getElementById('loader').style.display = 'none'; // fallback
            });
        }
      });

      // Component om controller inputs te luisteren
      AFRAME.registerComponent("input-listen", {
        init: function () {
          this.el.grip = false;
          this.el.addEventListener("triggerdown", (e) => {
            console.log("Trigger ingedrukt door:", e.target.id);
            this.el.grip = true;
          });
          this.el.addEventListener("triggerup", (e) => {
            console.log("Trigger losgelaten door:", e.target.id);
            this.el.grip = false;
          });
        },
      });

      // Scorebord en timer component
      AFRAME.registerComponent("score-timer", {
        schema: {
          initialScore: { type: 'int', default: 0 },
          duration: { type: 'int', default: 120 } // seconden
        },
        init: function () {
          const scene = this.el;
          let score = this.data.initialScore;
          let timeLeft = this.data.duration;

          // 🧮 Scorebord maken
          const scoreText = document.createElement("a-text");
          scoreText.setAttribute("value", "Score: " + score);
          scoreText.setAttribute("position", "0 5 -7");
          scoreText.setAttribute("align", "center");
          scoreText.setAttribute("anchor", "center");
          scoreText.setAttribute("side", "double");
          scoreText.setAttribute("color", "yellow");
          scoreText.setAttribute("scale", "3 3 3");
          scene.appendChild(scoreText);

          // Achtergrondblok
          const bg = document.createElement("a-plane");
          bg.setAttribute("width", 2);
          bg.setAttribute("height", 1);
          bg.setAttribute("color", "red");
          bg.setAttribute("position", "0 -0.15 -0.05");
          bg.setAttribute("side", "double");
          scoreText.appendChild(bg);

          // Gele rand
          const border = document.createElement("a-plane");
          border.setAttribute("width", 2.05);
          border.setAttribute("height", 1.05);
          border.setAttribute("color", "yellow");
          border.setAttribute("position", "0 -0.15 -0.06");
          scoreText.appendChild(border);

          // ⏱ Timer
          const timerText = document.createElement("a-text");
          timerText.setAttribute("value", "Time: " + timeLeft);
          timerText.setAttribute("position", "0 4 -7");
          timerText.setAttribute("align", "center");
          timerText.setAttribute("color", "white");
          timerText.setAttribute("scale", "2 2 2");
          scene.appendChild(timerText);

          const timerInterval = setInterval(() => {
            timeLeft--;
            timerText.setAttribute("value", "Time: " + timeLeft);
            if (timeLeft <= 0) {
              clearInterval(timerInterval);
              alert("Tijd is om! Je score: " + score);
            }
          }, 1000);

          // Functie om score bij te werken
          this.updateScore = function (points) {
            score += points;
            scoreText.setAttribute("value", "Score: " + score);
          };
        }
      });
    </script>

    <!-- Loader div -->
    <style>
      #loader {
        position: fixed;
        width: 100%;
        height: 100%;
        background: black;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2em;
        z-index: 9999;
      }
    </style>
  </head>

  <body>
    <!-- Loader -->
    <div id="loader">Loading VR...</div>

    <!-- 🌌 De VR-wereld -->
    <a-scene physics="debug: false"
             environment="preset: forest; lighting: point; lightPosition: -5 10 0;"
             score-timer
             preload-assets>
      
      <!-- 👤 Speler / camera rig -->
      <a-entity id="rig"
                movement-controls="constrainToNavMesh: true; controls: checkpoint, gamepad, keyboard, nipple;"
                position="0 0 0">
        
        <!-- 🎥 Camera -->
        <a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: true">
          <a-cursor></a-cursor>

          <!-- 🖐️ Linker controller -->
          <a-entity id="ctlL"
                    meta-touch-controls="hand: left"
                    input-listen>
          </a-entity>

          <!-- 🖐️ Rechter controller -->
          <a-entity id="ctlR"
                    meta-touch-controls="hand: right"
                    input-listen>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- 🌍 NavMesh & Model voorbeeld -->
      <a-assets>
        <a-asset-item id="navmesh" src="images/Castle-navmesh.glb"></a-asset-item>
        <img id="blauw" src="images/blauw.png"></img>
        <img id="groen" src="images/groen.png"></img>
        <img id="oranje" src="images/oranje.png"></img>
        <a-asset-item id="castle" src="images/Castle.glb"></a-asset-item>
      </a-assets>

      <a-sphere class="sphere-1" src="#oranje" scale="0.5 0.5 0.5" static-body position="-5 0.5 -6"
        animation__position="property: position; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; to: -5 1.0 -6"
        animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"></a-sphere>
      
      <a-sphere class="sphere-2" src="#blauw" scale="0.5 0.5 0.5" static-body position="-5 0.5 6"
        animation__position="property: position; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; to: -5 1.0 6"
        animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: easeInOutSine"></a-sphere>
      
      <a-sphere class="sphere-3" src="#groen" scale="0.5 0.5 0.5" static-body position="4.15 6.7 -3"
        animation__position="property: position; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; to: 4.15 7.2 -3"
        animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: ease-in-out-quad"></a-sphere>
      
      <a-entity nav-mesh visible="false" position="4 0 0" gltf-model="#navmesh"></a-entity>

      <a-entity position="4 0 0" scale="3 3 3" gltf-model="#castle"></a-entity>
    </a-scene>
  </body>
</html>
